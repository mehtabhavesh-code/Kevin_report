<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genre Taxonomy Tree Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a365d 0%, #2c5282 50%, #2b6cb0 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 100%; background: #ffffff; border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1); }
        h1 { text-align: center; color: #1a365d; margin-bottom: 10px; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        .stats { text-align: center; color: #718096; margin-bottom: 20px; font-size: 14px; }
        .stats span { font-weight: 600; color: #2d3748; }
        .legend { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4a5568; }
        .legend-box { width: 24px; height: 24px; border-radius: 6px; border: 2px solid #ddd; }
        .level-0 { background: linear-gradient(135deg, #e8f4f8, #d0e8f0); border-color: #0066cc !important; }
        .level-1 { background: linear-gradient(135deg, #fff4e6, #ffe8cc); border-color: #ff9800 !important; }
        .level-2 { background: linear-gradient(135deg, #f3e5f5, #e8d5eb); border-color: #9c27b0 !important; }
        .tree { margin-top: 20px; }
        .genre-node { margin: 8px 0; position: relative; }
        .genre-node.dragging-source { opacity: 0.3; transform: scale(0.98); }
        .node-content { padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: all 0.25s ease; border: 2px solid; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .node-content:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); transform: translateY(-1px); }
        .l0-node > .node-content { background: linear-gradient(135deg, #e8f4f8, #dceef5); border-color: #0066cc; color: #0055aa; font-size: 16px; }
        .l1-node > .node-content { background: linear-gradient(135deg, #fff4e6, #ffedd5); border-color: #ff9800; color: #e67700; font-size: 14px; margin-left: 40px; }
        .l2-node > .node-content { background: linear-gradient(135deg, #f3e5f5, #ead5ed); border-color: #9c27b0; color: #7b1fa2; font-size: 13px; margin-left: 80px; }
        .children { margin-top: 5px; }
        .collapsed { display: none; }
        .expand-icon { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; transition: transform 0.3s ease; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 11px; }
        .expand-icon:hover { background: rgba(0,0,0,0.08); }
        .node-content.expanded > .expand-icon { transform: rotate(90deg); }
        .node-count { display: inline-block; background: rgba(0,0,0,0.08); padding: 3px 10px; border-radius: 12px; font-size: 11px; margin-left: 6px; font-weight: 500; }
        .controls { text-align: center; margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .btn { background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.25s; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(0,102,204,0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,102,204,0.4); }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); box-shadow: 0 2px 8px rgba(40,167,69,0.3); }
        .btn-success:hover { box-shadow: 0 4px 12px rgba(40,167,69,0.4); }
        .btn-purple { background: linear-gradient(135deg, #6f42c1, #5a32a3); box-shadow: 0 2px 8px rgba(111,66,193,0.3); }
        .btn-purple:hover { box-shadow: 0 4px 12px rgba(111,66,193,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); box-shadow: 0 2px 8px rgba(108,117,125,0.3); }
        .btn-secondary:hover { box-shadow: 0 4px 12px rgba(108,117,125,0.4); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .node-label { flex: 1; min-width: 50px; }
        .node-label-input { flex: 1; border: 2px solid currentColor; border-radius: 6px; padding: 4px 8px; font-size: inherit; font-weight: inherit; font-family: inherit; color: inherit; background: white; min-width: 100px; outline: none; }
        .node-actions { display: none; gap: 4px; margin-left: auto; }
        .node-content:hover .node-actions { display: flex; }
        .action-btn { background: rgba(0,0,0,0.08); border: none; border-radius: 6px; width: 26px; height: 26px; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .action-btn:hover { background: rgba(0,0,0,0.15); transform: scale(1.1); }
        .action-btn.delete:hover { background: #ff4444; color: white; }
        .drag-handle { cursor: grab; padding: 0 4px; opacity: 0.3; user-select: none; font-size: 12px; transition: opacity 0.2s; }
        .drag-handle:hover { opacity: 0.8; }
        .drop-placeholder { border: 2px dashed #999; border-radius: 10px; background: rgba(0,0,0,0.03); margin: 8px 0; display: none; }
        .drop-placeholder.active { display: block; }
        .drop-placeholder.l0 { height: 48px; border-color: #0066cc; background: rgba(0,102,204,0.08); }
        .drop-placeholder.l1 { height: 44px; margin-left: 40px; border-color: #ff9800; background: rgba(255,152,0,0.08); }
        .drop-placeholder.l2 { height: 42px; margin-left: 80px; border-color: #9c27b0; background: rgba(156,39,176,0.08); }
        .level-indicator { position: fixed; padding: 8px 14px; background: rgba(45,55,72,0.95); color: white; border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 1000; display: none; backdrop-filter: blur(4px); }
        .level-indicator.active { display: block; }
        .level-indicator .level-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; margin-left: 4px; font-weight: 600; }
        .level-indicator .level-badge.l0 { background: #0066cc; }
        .level-indicator .level-badge.l1 { background: #ff9800; }
        .level-indicator .level-badge.l2 { background: #9c27b0; }
        .drag-ghost { position: fixed; padding: 10px 16px; border-radius: 10px; font-weight: 600; pointer-events: none; z-index: 999; opacity: 0.95; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: rotate(2deg); max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; }
        .drag-ghost.l0 { background: #e8f4f8; border: 2px solid #0066cc; color: #0066cc; }
        .drag-ghost.l1 { background: #fff4e6; border: 2px solid #ff9800; color: #f57c00; }
        .drag-ghost.l2 { background: #f3e5f5; border: 2px solid #9c27b0; color: #7b1fa2; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; box-shadow: 0 25px 80px rgba(0,0,0,0.35); max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .modal-title.danger { color: #c53030; }
        .modal-content { margin-bottom: 20px; }
        .delete-preview { background: #f7fafc; border-radius: 10px; padding: 14px; margin-top: 12px; font-size: 13px; max-height: 180px; overflow-y: auto; border: 1px solid #e2e8f0; }
        .delete-preview .preview-item { padding: 4px 0; display: flex; align-items: center; gap: 6px; }
        .delete-preview .preview-l0 { color: #0066cc; font-weight: 600; }
        .delete-preview .preview-l1 { color: #f57c00; margin-left: 16px; }
        .delete-preview .preview-l2 { color: #7b1fa2; margin-left: 32px; font-size: 12px; }
        .delete-summary { margin-top: 12px; padding: 10px 14px; background: #fff5f5; border-radius: 8px; color: #c53030; font-size: 13px; border: 1px solid #feb2b2; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .modal-btn-cancel { background: #edf2f7; color: #4a5568; }
        .modal-btn-cancel:hover { background: #e2e8f0; }
        .modal-btn-delete { background: linear-gradient(135deg, #e53e3e, #c53030); color: white; }
        .modal-btn-delete:hover { transform: translateY(-1px); }
        .modal-btn-primary { background: linear-gradient(135deg, #0066cc, #0052a3); color: white; }
        .modal-btn-primary:hover { transform: translateY(-1px); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 14px 28px; border-radius: 10px; font-size: 14px; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .toast.show { opacity: 1; }
        .toast.success { background: linear-gradient(135deg, #28a745, #1e7e34); }
        .toast.error { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .file-input { display: none; }
        .node-checkbox { width: 16px; height: 16px; cursor: pointer; accent-color: #0066cc; }
        .compare-mode .node-checkbox { display: inline-block !important; }
        .node-checkbox { display: none; }
        .info-icon { opacity: 0.4; font-size: 12px; cursor: pointer; transition: opacity 0.2s; }
        .node-content:hover .info-icon { opacity: 0.8; }
        .selected-count { background: linear-gradient(135deg, #0066cc, #0052a3); color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 4px; font-weight: 500; }

        /* Info Popup - Fixed for scrolling */
        .info-popup { 
            position: fixed; 
            background: white; 
            border-radius: 14px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.25); 
            z-index: 1500; 
            max-width: 520px; 
            width: 95%; 
            display: none; 
            border: 2px solid #e2e8f0;
            flex-direction: column;
            overflow: hidden;
        }
        .info-popup.active { display: flex; }
        .info-popup.l0 { border-color: #0066cc; }
        .info-popup.l1 { border-color: #ff9800; }
        .info-popup.l2 { border-color: #9c27b0; }
        .info-popup-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 18px 20px 14px 20px;
            border-bottom: 1px solid #e2e8f0; 
            flex-shrink: 0;
            background: white;
        }
        .info-popup-title { font-weight: 700; font-size: 17px; }
        .info-popup.l0 .info-popup-title { color: #0066cc; }
        .info-popup.l1 .info-popup-title { color: #f57c00; }
        .info-popup.l2 .info-popup-title { color: #7b1fa2; }
        .info-popup-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #a0aec0; transition: color 0.2s; }
        .info-popup-close:hover { color: #4a5568; }
        .info-popup-body {
            padding: 16px 20px 20px 20px;
            overflow-y: auto;
            flex: 1 1 auto;
            min-height: 0;
            max-height: calc(100% - 120px);
        }
        .info-popup-section { margin-bottom: 16px; }
        .info-popup-section:last-child { margin-bottom: 0; padding-bottom: 16px; }
        .info-popup-label { font-size: 11px; font-weight: 600; color: #718096; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .info-popup-edit { font-size: 10px; color: #0066cc; cursor: pointer; font-weight: 500; }
        .info-popup-edit:hover { text-decoration: underline; }
        .info-popup-text { font-size: 13px; line-height: 1.6; color: #4a5568; }
        .info-popup-text.collapsed { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .read-more-btn { color: #0066cc; cursor: pointer; font-size: 12px; margin-top: 6px; display: inline-block; font-weight: 500; }
        .read-more-btn:hover { text-decoration: underline; }
        .info-popup-tags { display: flex; flex-wrap: wrap; gap: 6px; max-height: 100px; overflow-y: auto; }
        .info-popup-tag { background: #edf2f7; padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #4a5568; font-weight: 500; }
        .info-popup-comparison { background: #f7fafc; border-radius: 10px; padding: 12px; margin-top: 8px; border: 1px solid #e2e8f0; }
        .info-popup-comp-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .info-popup-comp-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        .info-popup-comp-label { font-size: 11px; font-weight: 600; color: #0066cc; margin-bottom: 3px; }
        .info-popup-comp-text { font-size: 12px; color: #4a5568; line-height: 1.5; }
        .info-popup-textarea { width: 100%; min-height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; transition: border-color 0.2s; }
        .info-popup-textarea:focus { outline: none; border-color: #0066cc; }
        .info-popup-input { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; margin-bottom: 4px; }
        .info-popup-actions { 
            display: none; 
            gap: 10px; 
            justify-content: flex-end; 
            padding: 14px 20px;
            border-top: 1px solid #e2e8f0; 
            background: #f7fafc;
            border-radius: 0 0 12px 12px;
            flex-shrink: 0;
        }
        .info-popup-actions.visible {
            display: flex;
        }

        /* Compare Modal */
        .compare-modal { max-width: 90%; width: 90%; max-height: 85vh; padding: 20px; }
        .compare-table-wrapper { overflow-x: auto; max-height: 65vh; }
        .compare-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .compare-table th, .compare-table td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; vertical-align: top; }
        .compare-table th { background: #f7fafc; font-weight: 600; position: sticky; top: 0; z-index: 1; color: #4a5568; }
        .compare-table th:first-child { min-width: 140px; background: #edf2f7; }
        .compare-table td:first-child { font-weight: 600; background: #f7fafc; min-width: 140px; color: #4a5568; }
        .compare-table td { min-width: 180px; max-width: 280px; }
        .compare-header-cell { max-width: 200px; }
        .compare-header-cell .level-badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; margin-bottom: 4px; color: white; font-weight: 600; }
        .compare-header-cell .level-badge.l0 { background: #0066cc; }
        .compare-header-cell .level-badge.l1 { background: #ff9800; }
        .compare-header-cell .level-badge.l2 { background: #9c27b0; }
        .compare-header-cell .name { font-size: 13px; word-wrap: break-word; }
        .compare-tag { display: inline-block; background: #e8f4f8; padding: 3px 8px; border-radius: 8px; font-size: 10px; margin: 2px; font-weight: 500; }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 22px; }
            .l1-node > .node-content, .drop-placeholder.l1 { margin-left: 20px; }
            .l2-node > .node-content, .drop-placeholder.l2 { margin-left: 40px; }
            .btn { padding: 8px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Audio Show Genre Taxonomy</h1>
        <div class="stats" id="stats"></div>
        <div class="legend">
            <div class="legend-item"><div class="legend-box level-0"></div><span>L0: Main Genre</span></div>
            <div class="legend-item"><div class="legend-box level-1"></div><span>L1: Sub-Genre</span></div>
            <div class="legend-item"><div class="legend-box level-2"></div><span>L2: Sub-Sub-Genre</span></div>
        </div>
        <div class="controls">
            <button class="btn" onclick="expandAll()">Expand All</button>
            <button class="btn" onclick="collapseAll()">Collapse All</button>
            <button class="btn" onclick="addL0Node()">+ Add Genre</button>
            <button class="btn btn-purple" id="compareBtn" onclick="toggleCompareMode()">üîÄ Compare</button>
            <button class="btn btn-secondary" onclick="importJSON()">üìÇ Import JSON</button>
            <button class="btn btn-success" onclick="downloadJSON()">üì• Export JSON</button>
            <button class="btn btn-success" onclick="downloadHTML()">üìÑ Export HTML</button>
        </div>
        <div id="compareBar" style="display:none; text-align:center; padding:12px; background:linear-gradient(135deg, #e8f4f8, #dceef5); border-radius:10px; margin-bottom:15px; border: 1px solid #bee3f8;">
            <span style="color:#2c5282;">Select up to 5 nodes to compare</span>
            <span class="selected-count" id="selectedCount">0</span>
            <button class="btn btn-purple" id="runCompareBtn" onclick="showCompareModal()" disabled style="margin-left:10px;">Compare Selected</button>
            <button class="btn btn-secondary" onclick="toggleCompareMode()" style="margin-left:5px;">Cancel</button>
        </div>
        <div class="tree" id="tree"></div>
    </div>
    <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileImport(event)">
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-title danger">‚ö†Ô∏è Confirm Deletion</div>
            <div class="modal-content">
                <p>You are about to delete:</p>
                <div class="delete-preview" id="deletePreview"></div>
                <div class="delete-summary" id="deleteSummary"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="modal-btn modal-btn-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="compareModal">
        <div class="modal compare-modal">
            <div class="modal-title">üîÄ Genre Comparison</div>
            <div class="compare-table-wrapper" id="compareTableWrapper"></div>
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="modal-btn modal-btn-cancel" onclick="closeCompareModal()">Close</button>
            </div>
        </div>
    </div>
    <div class="info-popup" id="infoPopup">
        <div class="info-popup-header">
            <span class="info-popup-title" id="infoPopupTitle">Genre Name</span>
            <button class="info-popup-close" onclick="closeInfoPopup()">√ó</button>
        </div>
        <div class="info-popup-body" id="infoPopupBody">
            <div id="infoPopupContent"></div>
        </div>
        <div class="info-popup-actions" id="infoPopupActions">>
            <button class="modal-btn modal-btn-cancel" onclick="closeInfoPopup()">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveInfoPopup()">Save</button>
        </div>
    </div>
    <div class="level-indicator" id="levelIndicator"></div>
    <div class="drag-ghost" id="dragGhost"></div>
    <div class="toast" id="toast"></div>
    <script>
        const EMBEDDED_TAXONOMY = null;
        const COMPARISON_KEYS = ["Primary_Plot_Driver","Setting_And_World","Central_Conflict_Type","Tone_And_Atmosphere","Character_Arc_Focus","Power_Ability_System","Stakes_And_Consequences"];
        const COMPARISON_LABELS = {"Primary_Plot_Driver":"Primary Plot Driver","Setting_And_World":"Setting & World","Central_Conflict_Type":"Central Conflict Type","Tone_And_Atmosphere":"Tone & Atmosphere","Character_Arc_Focus":"Character Arc Focus","Power_Ability_System":"Power/Ability System","Stakes_And_Consequences":"Stakes & Consequences"};

        let taxonomy = EMBEDDED_TAXONOMY || {"Genre":{}};
        let expandedState = new Set();
        let dragState = { active: false };
        let pendingDelete = null;
        let infoPopupState = { path: null, level: null, editing: false };
        let hoverTimeout = null;
        let compareMode = false;
        let selectedNodes = [];

        function getNodeData(path, level) {
            const g = taxonomy.Genre;
            if (level === 0) return g[path[0]];
            if (level === 1) return g[path[0]]?.["Sub-Genre"]?.[path[1]];
            if (level === 2) return g[path[0]]?.["Sub-Genre"]?.[path[1]]?.["Sub-Sub-Genre"]?.[path[2]];
            return null;
        }

        function setNodeField(path, level, key, value) {
            const g = taxonomy.Genre;
            let node = level === 0 ? g[path[0]] : level === 1 ? g[path[0]]?.["Sub-Genre"]?.[path[1]] : g[path[0]]?.["Sub-Genre"]?.[path[1]]?.["Sub-Sub-Genre"]?.[path[2]];
            if (node) node[key] = value;
        }

        function importJSON() { document.getElementById('fileInput').click(); }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.Genre && typeof imported.Genre === 'object') {
                        taxonomy = imported;
                        createTree(false);
                        showToast('Taxonomy imported!', 'success');
                    } else throw new Error('Invalid format');
                } catch (err) { showToast('Invalid JSON: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function downloadJSON() {
            const json = JSON.stringify(taxonomy, null, 2);
            downloadFile(json, 'genre_taxonomy.json', 'application/json');
            showToast('JSON exported!', 'success');
        }

        function downloadHTML() {
            let html = document.documentElement.outerHTML;
            const ts = JSON.stringify(taxonomy, null, 8);
            html = html.replace(/const EMBEDDED_TAXONOMY = null;/, `const EMBEDDED_TAXONOMY = ${ts};`);
            downloadFile(html, 'genre_taxonomy_editor.html', 'text/html');
            showToast('HTML exported!', 'success');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast show ' + type;
            setTimeout(() => t.className = 'toast', 3000);
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function closeCompareModal() {
            closeModal('compareModal');
            if (compareMode) {
                toggleCompareMode();
            }
        }

        function updateStats() {
            let l0 = 0, l1 = 0, l2 = 0;
            const g = taxonomy.Genre || {};
            l0 = Object.keys(g).length;
            Object.values(g).forEach(x => {
                const s = x["Sub-Genre"] || {};
                l1 += Object.keys(s).length;
                Object.values(s).forEach(y => l2 += Object.keys(y["Sub-Sub-Genre"] || {}).length);
            });
            document.getElementById('stats').innerHTML = `<span>${l0}</span> Main Genres ‚Ä¢ <span>${l1}</span> Sub-Genres ‚Ä¢ <span>${l2}</span> Sub-Sub-Genres`;
        }

        function saveExpandedState() {
            expandedState.clear();
            document.querySelectorAll('.node-content.expanded').forEach(el => {
                const n = el.closest('.genre-node');
                if (n) expandedState.add(n.dataset.path);
            });
        }

        function restoreExpandedState() {
            document.querySelectorAll('.genre-node').forEach(n => {
                const p = n.dataset.path;
                const c = n.querySelector(':scope > .node-content');
                const ch = n.querySelector(':scope > .children');
                if (expandedState.has(p)) { c?.classList.add('expanded'); ch?.classList.remove('collapsed'); }
                else { c?.classList.remove('expanded'); ch?.classList.add('collapsed'); }
            });
        }

        function createTree(preserveState = true) {
            if (preserveState) saveExpandedState();
            const tree = document.getElementById('tree');
            tree.innerHTML = '';
            const g = taxonomy.Genre || {};
            Object.keys(g).forEach(l0 => {
                const n0 = createNode(l0, 0, [l0]);
                const c0 = n0.querySelector('.children');
                const subs = g[l0]["Sub-Genre"] || {};
                Object.keys(subs).forEach(l1 => {
                    const n1 = createNode(l1, 1, [l0, l1]);
                    const c1 = n1.querySelector('.children');
                    const subsubs = subs[l1]["Sub-Sub-Genre"] || {};
                    Object.keys(subsubs).forEach(l2 => c1.appendChild(createNode(l2, 2, [l0, l1, l2])));
                    c0.appendChild(n1);
                });
                tree.appendChild(n0);
            });
            updateStats();
            if (preserveState) restoreExpandedState();
            if (compareMode) document.getElementById('tree').classList.add('compare-mode');
        }

        function createNode(name, level, path) {
            const node = document.createElement('div');
            node.className = `genre-node l${level}-node`;
            node.dataset.level = level;
            node.dataset.path = path.join('|||');
            node.dataset.name = name;
            const hasChildren = level < 2;
            let childCount = '';
            const g = taxonomy.Genre;
            if (level === 0) {
                const s = g[path[0]]?.["Sub-Genre"] || {};
                const l1c = Object.keys(s).length;
                let l2c = 0;
                Object.values(s).forEach(x => l2c += Object.keys(x["Sub-Sub-Genre"] || {}).length);
                childCount = `<span class="node-count">${l1c} sub, ${l2c} cat</span>`;
            } else if (level === 1) {
                const ss = g[path[0]]?.["Sub-Genre"]?.[path[1]]?.["Sub-Sub-Genre"] || {};
                childCount = `<span class="node-count">${Object.keys(ss).length}</span>`;
            }
            const pathStr = path.join('|||');
            node.innerHTML = `
                <div class="node-content" draggable="true">
                    <input type="checkbox" class="node-checkbox" data-path="${pathStr}" data-level="${level}" data-name="${name}" onclick="event.stopPropagation();toggleNodeSelection(this)">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    ${hasChildren ? '<span class="expand-icon">‚ñ∂</span>' : ''}
                    <span class="node-label">${name}</span>
                    <span class="info-icon" title="View details">‚ÑπÔ∏è</span>
                    ${childCount}
                    <div class="node-actions">
                        <button class="action-btn" onclick="event.stopPropagation();startRename(this)" title="Rename">‚úèÔ∏è</button>
                        ${hasChildren ? `<button class="action-btn" onclick="event.stopPropagation();addChild('${pathStr}',${level})" title="Add">‚ûï</button>` : ''}
                        <button class="action-btn delete" onclick="event.stopPropagation();showDeleteModal('${pathStr}',${level})" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
                ${hasChildren ? '<div class="children collapsed"></div>' : ''}`;
            const content = node.querySelector('.node-content');
            const label = node.querySelector('.node-label');
            const infoIcon = node.querySelector('.info-icon');
            if (hasChildren) {
                node.querySelector('.expand-icon').addEventListener('click', e => {
                    e.stopPropagation();
                    content.classList.toggle('expanded');
                    node.querySelector('.children').classList.toggle('collapsed');
                });
            }
            label.addEventListener('dblclick', e => { e.stopPropagation(); startRename(label); });
            infoIcon.addEventListener('mouseenter', e => { hoverTimeout = setTimeout(() => showInfoPopup(path, level, e.clientX, e.clientY), 400); });
            infoIcon.addEventListener('mouseleave', () => clearTimeout(hoverTimeout));
            infoIcon.addEventListener('click', e => { e.stopPropagation(); clearTimeout(hoverTimeout); showInfoPopup(path, level, e.clientX, e.clientY); });
            content.addEventListener('mousedown', e => { content.draggable = e.target.classList.contains('drag-handle'); });
            content.addEventListener('dragstart', e => handleDragStart(e, node));
            content.addEventListener('dragend', handleDragEnd);
            node.addEventListener('dragover', e => handleDragOver(e, node));
            node.addEventListener('drop', e => handleDrop(e, node));
            return node;
        }

        function toggleCompareMode() {
            compareMode = !compareMode;
            selectedNodes = [];
            document.getElementById('compareBar').style.display = compareMode ? 'block' : 'none';
            document.getElementById('compareBtn').textContent = compareMode ? '‚ùå Exit Compare' : 'üîÄ Compare';
            document.getElementById('tree').classList.toggle('compare-mode', compareMode);
            document.querySelectorAll('.node-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function toggleNodeSelection(cb) {
            const pathStr = cb.dataset.path;
            if (cb.checked) {
                if (selectedNodes.length >= 5) { cb.checked = false; showToast('Max 5 nodes', 'error'); return; }
                selectedNodes.push({ path: pathStr.split('|||'), level: parseInt(cb.dataset.level), name: cb.dataset.name });
            } else {
                selectedNodes = selectedNodes.filter(n => n.path.join('|||') !== pathStr);
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedNodes.length;
            document.getElementById('runCompareBtn').disabled = selectedNodes.length < 2;
        }

        function showCompareModal() {
            if (selectedNodes.length < 2) return;
            const wrapper = document.getElementById('compareTableWrapper');
            let html = '<table class="compare-table"><thead><tr><th>Attribute</th>';
            selectedNodes.forEach(n => {
                html += `<th class="compare-header-cell"><div class="level-badge l${n.level}">L${n.level}</div><div class="name">${n.name}</div></th>`;
            });
            html += '</tr></thead><tbody>';
            html += '<tr><td>Examples</td>';
            selectedNodes.forEach(n => {
                const data = getNodeData(n.path, n.level);
                const ex = data?.Examples || [];
                html += `<td>${ex.length ? ex.map(e => `<span class="compare-tag">${e}</span>`).join('') : '<em>None</em>'}</td>`;
            });
            html += '</tr>';
            COMPARISON_KEYS.forEach(key => {
                html += `<tr><td>${COMPARISON_LABELS[key]}</td>`;
                selectedNodes.forEach(n => {
                    const data = getNodeData(n.path, n.level);
                    const val = data?.Comparison?.[key] || '';
                    html += `<td>${val || '<em>Not defined</em>'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            wrapper.innerHTML = html;
            document.getElementById('compareModal').classList.add('active');
        }

        function showInfoPopup(path, level, x, y) {
            const data = getNodeData(path, level);
            if (!data) return;
            const popup = document.getElementById('infoPopup');
            const title = document.getElementById('infoPopupTitle');
            const content = document.getElementById('infoPopupContent');
            const actions = document.getElementById('infoPopupActions');
            popup.className = `info-popup active l${level}`;
            title.textContent = path[level];
            infoPopupState = { path: [...path], level, editing: false, defExpanded: false };
            const def = data.Definition || '';
            const examples = data.Examples || [];
            const themes = data.Key_Themes || [];
            const comp = data.Comparison || {};
            let compHtml = '';
            COMPARISON_KEYS.forEach(key => {
                compHtml += `<div class="info-popup-comp-item"><div class="info-popup-comp-label">${COMPARISON_LABELS[key]}</div><div class="info-popup-comp-text">${comp[key] || '<em>Not defined</em>'}</div></div>`;
            });
            content.innerHTML = `
                <div class="info-popup-section">
                    <div class="info-popup-label">Definition <span class="info-popup-edit" onclick="editAllFields()">‚úèÔ∏è Edit All</span></div>
                    <div class="info-popup-text collapsed" id="defText">${def || '<em>No definition</em>'}</div>
                    <span class="read-more-btn" id="readMoreBtn" onclick="toggleDefExpand()">Read More</span>
                </div>
                <div class="info-popup-section">
                    <div class="info-popup-label">Examples</div>
                    <div class="info-popup-tags">${examples.length ? examples.map(e => `<span class="info-popup-tag">${e}</span>`).join('') : '<em style="font-size:12px;color:#a0aec0;">No examples</em>'}</div>
                </div>
                <div class="info-popup-section">
                    <div class="info-popup-label">Key Themes</div>
                    <div class="info-popup-tags">${themes.length ? themes.map(t => `<span class="info-popup-tag">${t}</span>`).join('') : '<em style="font-size:12px;color:#a0aec0;">No themes</em>'}</div>
                </div>
                <div class="info-popup-section">
                    <div class="info-popup-label">Comparison</div>
                    <div class="info-popup-comparison">${compHtml}</div>
                </div>`;
            actions.classList.remove('visible');
            
            // Calculate position ensuring popup stays within viewport
            const margin = 20;
            const popupWidth = Math.min(520, window.innerWidth - margin * 2);
            const maxHeight = window.innerHeight - margin * 2;
            
            let left = x + 10;
            let top = y + 10;
            
            // Adjust horizontal position
            if (left + popupWidth > window.innerWidth - margin) {
                left = Math.max(margin, window.innerWidth - popupWidth - margin);
            }
            
            // Adjust vertical position - keep popup fully visible
            if (top + maxHeight > window.innerHeight - margin) {
                top = margin;
            }
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.style.maxHeight = (window.innerHeight - top - margin) + 'px';
        }

        function toggleDefExpand() {
            const defText = document.getElementById('defText');
            const btn = document.getElementById('readMoreBtn');
            if (defText.classList.contains('collapsed')) {
                defText.classList.remove('collapsed');
                btn.textContent = 'Show Less';
            } else {
                defText.classList.add('collapsed');
                btn.textContent = 'Read More';
            }
        }

        function editAllFields() {
            const data = getNodeData(infoPopupState.path, infoPopupState.level);
            if (!data) return;
            const content = document.getElementById('infoPopupContent');
            const actions = document.getElementById('infoPopupActions');
            infoPopupState.editing = true;
            const def = data.Definition || '';
            const examples = (data.Examples || []).join('\n');
            const themes = (data.Key_Themes || []).join('\n');
            const comp = data.Comparison || {};
            let compInputs = '';
            COMPARISON_KEYS.forEach(key => {
                compInputs += `<div style="margin-bottom:10px;"><label style="font-size:11px;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">${COMPARISON_LABELS[key]}</label><textarea class="info-popup-textarea" id="comp_${key}" style="min-height:40px;margin-top:4px;">${comp[key] || ''}</textarea></div>`;
            });
            content.innerHTML = `
                <div class="info-popup-section"><div class="info-popup-label">Definition</div><textarea class="info-popup-textarea" id="editDef">${def}</textarea></div>
                <div class="info-popup-section"><div class="info-popup-label">Examples (one per line)</div><textarea class="info-popup-textarea" id="editExamples" style="min-height:50px;">${examples}</textarea></div>
                <div class="info-popup-section"><div class="info-popup-label">Key Themes (one per line)</div><textarea class="info-popup-textarea" id="editThemes" style="min-height:50px;">${themes}</textarea></div>
                <div class="info-popup-section"><div class="info-popup-label">Comparison</div>${compInputs}</div>`;
            actions.classList.add('visible');
            
            // Reposition popup to ensure it fits with actions visible
            const popup = document.getElementById('infoPopup');
            const margin = 20;
            const currentTop = parseInt(popup.style.top) || margin;
            popup.style.maxHeight = (window.innerHeight - currentTop - margin) + 'px';
            
            // Scroll to top of edit form
            document.getElementById('infoPopupBody').scrollTop = 0;
        }

        function saveInfoPopup() {
            const def = document.getElementById('editDef').value.trim();
            const exText = document.getElementById('editExamples').value.trim();
            const thText = document.getElementById('editThemes').value.trim();
            const examples = exText ? exText.split('\n').map(x => x.trim()).filter(x => x) : [];
            const themes = thText ? thText.split('\n').map(x => x.trim()).filter(x => x) : [];
            const comp = {};
            COMPARISON_KEYS.forEach(key => { comp[key] = document.getElementById('comp_' + key).value.trim(); });
            setNodeField(infoPopupState.path, infoPopupState.level, 'Definition', def);
            setNodeField(infoPopupState.path, infoPopupState.level, 'Examples', examples);
            setNodeField(infoPopupState.path, infoPopupState.level, 'Key_Themes', themes);
            setNodeField(infoPopupState.path, infoPopupState.level, 'Comparison', comp);
            showToast('Saved!', 'success');
            closeInfoPopup();
        }

        function closeInfoPopup() {
            document.getElementById('infoPopup').classList.remove('active');
            infoPopupState = { path: null, level: null, editing: false };
        }

        function startRename(el, selectAll = false) {
            const node = el.closest('.genre-node');
            const label = node.querySelector('.node-label');
            const currentName = node.dataset.name;
            const path = node.dataset.path.split('|||');
            const level = parseInt(node.dataset.level);
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'node-label-input'; input.value = currentName;
            label.replaceWith(input); input.focus();
            if (selectAll) input.select(); else input.setSelectionRange(input.value.length, input.value.length);
            const save = () => { const nn = input.value.trim() || currentName; if (nn !== currentName) renameInTaxonomy(path, level, currentName, nn); createTree(); };
            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } if (e.key === 'Escape') { input.value = currentName; input.blur(); } });
        }

        function renameInTaxonomy(path, level, oldName, newName) {
            const g = taxonomy.Genre;
            if (level === 0) { const n = {}; for (const k of Object.keys(g)) n[k === oldName ? newName : k] = g[k]; taxonomy.Genre = n; }
            else if (level === 1) { const s = g[path[0]]["Sub-Genre"]; const n = {}; for (const k of Object.keys(s)) n[k === oldName ? newName : k] = s[k]; g[path[0]]["Sub-Genre"] = n; }
            else { const ss = g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"]; const n = {}; for (const k of Object.keys(ss)) n[k === oldName ? newName : k] = ss[k]; g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"] = n; }
        }

        function addChild(pathStr, level) {
            const path = pathStr.split('|||');
            const names = ['Main Genre', 'Sub-Genre', 'Category'];
            const newName = `New ${names[level + 1]}`;
            const g = taxonomy.Genre;
            const template = { Definition: '', Key_Themes: [], Examples: [], Comparison: {} };
            if (level === 0) { if (!g[path[0]]["Sub-Genre"]) g[path[0]]["Sub-Genre"] = {}; g[path[0]]["Sub-Genre"][newName] = { ...template, "Sub-Sub-Genre": {} }; }
            else { if (!g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"]) g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"] = {}; g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"][newName] = { ...template }; }
            expandedState.add(pathStr);
            if (level === 1) expandedState.add(path[0]);
            createTree();
            setTimeout(() => { const np = level === 0 ? `${path[0]}|||${newName}` : `${path[0]}|||${path[1]}|||${newName}`; const nn = document.querySelector(`[data-path="${np}"]`); if (nn) startRename(nn.querySelector('.node-label'), true); }, 50);
        }

        function addL0Node() {
            const newName = 'New Main Genre';
            taxonomy.Genre[newName] = { Definition: '', Key_Themes: [], Examples: [], Comparison: {}, "Sub-Genre": {} };
            createTree();
            setTimeout(() => { const nn = document.querySelector(`[data-path="${newName}"]`); if (nn) startRename(nn.querySelector('.node-label'), true); }, 50);
        }

        function showDeleteModal(pathStr, level) {
            const path = pathStr.split('|||');
            const preview = document.getElementById('deletePreview');
            const summary = document.getElementById('deleteSummary');
            let html = '', l1c = 0, l2c = 0;
            const g = taxonomy.Genre;
            if (level === 0) {
                html += `<div class="preview-item preview-l0">üìÅ ${path[0]}</div>`;
                const s = g[path[0]]?.["Sub-Genre"] || {};
                Object.keys(s).forEach(l1 => { l1c++; html += `<div class="preview-item preview-l1">üìÇ ${l1}</div>`; Object.keys(s[l1]["Sub-Sub-Genre"] || {}).forEach(l2 => { l2c++; html += `<div class="preview-item preview-l2">üìÑ ${l2}</div>`; }); });
                summary.innerHTML = `Delete <strong>1 Main Genre</strong>, <strong>${l1c} Sub-Genres</strong>, <strong>${l2c} Categories</strong>`;
            } else if (level === 1) {
                html += `<div class="preview-item preview-l1">üìÇ ${path[1]}</div>`;
                const ss = g[path[0]]?.["Sub-Genre"]?.[path[1]]?.["Sub-Sub-Genre"] || {};
                Object.keys(ss).forEach(l2 => { l2c++; html += `<div class="preview-item preview-l2">üìÑ ${l2}</div>`; });
                summary.innerHTML = `Delete <strong>1 Sub-Genre</strong>, <strong>${l2c} Categories</strong>`;
            } else { html += `<div class="preview-item preview-l2">üìÑ ${path[2]}</div>`; summary.innerHTML = `Delete <strong>1 Category</strong>`; }
            preview.innerHTML = html;
            pendingDelete = { path, level };
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('confirmDeleteBtn').onclick = confirmDelete;
        }

        function confirmDelete() {
            if (!pendingDelete) return;
            const { path, level } = pendingDelete;
            const g = taxonomy.Genre;
            if (level === 0) delete g[path[0]];
            else if (level === 1) delete g[path[0]]["Sub-Genre"][path[1]];
            else delete g[path[0]]["Sub-Genre"][path[1]]["Sub-Sub-Genre"][path[2]];
            closeModal('deleteModal');
            pendingDelete = null;
            createTree();
        }

        function handleDragStart(e, node) {
            e.stopPropagation();
            dragState = { active: true, sourceNode: node, sourcePath: node.dataset.path, sourceLevel: parseInt(node.dataset.level), sourceName: node.dataset.name };
            node.classList.add('dragging-source');
            const ghost = document.getElementById('dragGhost');
            ghost.textContent = node.dataset.name;
            ghost.className = `drag-ghost l${node.dataset.level}`;
            const img = new Image(); img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            e.dataTransfer.setDragImage(img, 0, 0);
            dragState.placeholder = document.createElement('div');
            dragState.placeholder.className = 'drop-placeholder';
        }

        function handleDragEnd() {
            if (!dragState.active) return;
            dragState.sourceNode?.classList.remove('dragging-source');
            document.getElementById('dragGhost').style.display = 'none';
            document.getElementById('levelIndicator').classList.remove('active');
            dragState.placeholder?.remove();
            dragState = { active: false };
        }

        function handleDragOver(e, targetNode) {
            e.preventDefault(); e.stopPropagation();
            if (!dragState.active || targetNode === dragState.sourceNode || targetNode.contains(dragState.sourceNode)) return;
            const tl = parseInt(targetNode.dataset.level);
            const rect = targetNode.querySelector('.node-content').getBoundingClientRect();
            const before = e.clientY < rect.top + rect.height / 2;
            const rx = e.clientX - rect.left;
            let dl = tl;
            if (rx > 120 && tl <= 1) dl = 2; else if (rx > 60 && tl === 0) dl = 1;
            const ghost = document.getElementById('dragGhost');
            ghost.style.display = 'block'; ghost.style.left = (e.clientX + 15) + 'px'; ghost.style.top = (e.clientY - 20) + 'px';
            const ind = document.getElementById('levelIndicator');
            const names = ['Main Genre', 'Sub-Genre', 'Category'];
            ind.innerHTML = `Drop as <span class="level-badge l${dl}">${names[dl]}</span>`;
            ind.style.left = (e.clientX + 15) + 'px'; ind.style.top = (e.clientY + 20) + 'px';
            ind.classList.add('active');
            const ph = dragState.placeholder;
            ph.className = `drop-placeholder active l${dl}`;
            ph.dataset.targetPath = targetNode.dataset.path;
            ph.dataset.insertBefore = before;
            ph.dataset.dropLevel = dl;
            if (before) targetNode.parentNode.insertBefore(ph, targetNode);
            else targetNode.parentNode.insertBefore(ph, targetNode.nextSibling);
        }

        function handleDrop(e, targetNode) {
            e.preventDefault(); e.stopPropagation();
            if (!dragState.active || !dragState.placeholder?.parentNode) return;
            const dl = parseInt(dragState.placeholder.dataset.dropLevel);
            const tp = dragState.placeholder.dataset.targetPath.split('|||');
            const before = dragState.placeholder.dataset.insertBefore === 'true';
            const sp = dragState.sourcePath.split('|||');
            const sl = dragState.sourceLevel;
            const sn = dragState.sourceName;
            let sd = extractAndRemove(sp, sl);
            insertAtLocation(sn, sd, sl, dl, tp, before);
            handleDragEnd();
            createTree();
        }

        function extractAndRemove(p, l) {
            const g = taxonomy.Genre; let d = null;
            if (l === 0) { d = g[p[0]]; delete g[p[0]]; }
            else if (l === 1) { d = g[p[0]]["Sub-Genre"][p[1]]; delete g[p[0]]["Sub-Genre"][p[1]]; }
            else { d = g[p[0]]["Sub-Genre"][p[1]]["Sub-Sub-Genre"][p[2]]; delete g[p[0]]["Sub-Genre"][p[1]]["Sub-Sub-Genre"][p[2]]; }
            return d;
        }

        function insertAtLocation(name, data, sl, dl, tp, before) {
            const g = taxonomy.Genre;
            const base = { Definition: data.Definition || '', Key_Themes: data.Key_Themes || [], Examples: data.Examples || [], Comparison: data.Comparison || {} };
            if (dl === 0) {
                let nd = sl === 0 ? data : { ...base, "Sub-Genre": sl === 1 ? { [name]: data } : {} };
                const ng = {}; let ins = false;
                for (const k of Object.keys(g)) { if (k === tp[0] && before && !ins) { ng[name] = nd; ins = true; } ng[k] = g[k]; if (k === tp[0] && !before && !ins) { ng[name] = nd; ins = true; } }
                if (!ins) ng[name] = nd;
                taxonomy.Genre = ng;
            } else if (dl === 1) {
                let nd = sl === 0 ? (data["Sub-Genre"]?.[Object.keys(data["Sub-Genre"] || {})[0]] || { ...base, "Sub-Sub-Genre": {} }) : sl === 1 ? data : { ...base, "Sub-Sub-Genre": {} };
                const parent = g[tp[0]]["Sub-Genre"];
                const ns = {}; let ins = false;
                for (const k of Object.keys(parent)) { if (k === tp[1] && before && !ins) { ns[name] = nd; ins = true; } ns[k] = parent[k]; if (k === tp[1] && !before && !ins) { ns[name] = nd; ins = true; } }
                if (!ins) ns[name] = nd;
                g[tp[0]]["Sub-Genre"] = ns;
            } else {
                const nd = { ...base };
                const parent = g[tp[0]]["Sub-Genre"][tp[1]]["Sub-Sub-Genre"];
                const nss = {}; let ins = false;
                for (const k of Object.keys(parent)) { if (k === tp[2] && before && !ins) { nss[name] = nd; ins = true; } nss[k] = parent[k]; if (k === tp[2] && !before && !ins) { nss[name] = nd; ins = true; } }
                if (!ins) nss[name] = nd;
                g[tp[0]]["Sub-Genre"][tp[1]]["Sub-Sub-Genre"] = nss;
            }
        }

        document.getElementById('tree').addEventListener('dragover', e => {
            if (!dragState.active) return;
            const last = document.querySelector('.genre-node.l0-node:last-child');
            if (last && e.clientY > last.getBoundingClientRect().bottom) {
                e.preventDefault();
                const ph = dragState.placeholder;
                ph.className = 'drop-placeholder active l0';
                ph.dataset.targetPath = ''; ph.dataset.dropLevel = '0';
                document.getElementById('tree').appendChild(ph);
                const ghost = document.getElementById('dragGhost');
                ghost.style.display = 'block'; ghost.style.left = (e.clientX + 15) + 'px'; ghost.style.top = (e.clientY - 20) + 'px';
                const ind = document.getElementById('levelIndicator');
                ind.innerHTML = 'Drop as <span class="level-badge l0">Main Genre</span>';
                ind.style.left = (e.clientX + 15) + 'px'; ind.style.top = (e.clientY + 20) + 'px';
                ind.classList.add('active');
            }
        });

        document.getElementById('tree').addEventListener('drop', e => {
            if (!dragState.active || dragState.placeholder?.dataset.targetPath !== '') return;
            e.preventDefault();
            const sd = extractAndRemove(dragState.sourcePath.split('|||'), dragState.sourceLevel);
            const base = { Definition: sd.Definition || '', Key_Themes: sd.Key_Themes || [], Examples: sd.Examples || [], Comparison: sd.Comparison || {} };
            let nd = dragState.sourceLevel === 0 ? sd : dragState.sourceLevel === 1 ? { ...base, "Sub-Genre": { [dragState.sourceName]: sd } } : { ...base, "Sub-Genre": {} };
            taxonomy.Genre[dragState.sourceName] = nd;
            handleDragEnd();
            createTree();
        });

        function expandAll() { document.querySelectorAll('.node-content').forEach(n => n.classList.add('expanded')); document.querySelectorAll('.children').forEach(c => c.classList.remove('collapsed')); }
        function collapseAll() { document.querySelectorAll('.node-content').forEach(n => n.classList.remove('expanded')); document.querySelectorAll('.children').forEach(c => c.classList.add('collapsed')); }

        document.addEventListener('dragover', e => { if (dragState.active) e.preventDefault(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal('deleteModal'); closeCompareModal(); closeInfoPopup(); if (compareMode) toggleCompareMode(); } });
        document.addEventListener('click', e => {
            const popup = document.getElementById('infoPopup');
            if (popup.classList.contains('active') && !popup.contains(e.target) && !e.target.classList.contains('info-icon')) {
                if (!infoPopupState.editing) closeInfoPopup();
            }
        });

        createTree(false);
    </script>
</body>
</html>
